<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inspecto Demo</title>
</head>
<style>
  body {
    height: 100vh;
    margin: 0;
  }

  .wrapper {
    display: flex;
    gap: 12px;
  }

  .success {
    color: green;
  }

  #inspecto {
    margin: 12px 0;
    display: block;
  }

  .rule-config {
    margin-bottom: 12px;
  }
</style>

<body>
  <div class="wrapper">
    <iframe id="ketcher" width="800" height="600" src="./ketcher/index.html" frameborder="0"></iframe>
    <section class="inspecto">
      <h1>Inspecto</h1>
      <h2>Rules Configuration</h2>

      <h3>Tripple Bond Angle</h3>
      <div class="rule-config">
        <label for="angleDiffError">Angle Difference Error</label>
        <input type="text" id="angleDiffError">
      </div>
      <div class="rule-config">
        <label for="fixingRule">Fixing Rule?</label>
        <input type="checkbox" id="fixingRule">
      </div>

      <h3>Bond Length</h3>
      <div class="rule-config">
        <label for="bondLengthDifferenceError">Bond Length Difference Error</label>
        <input type="text" id="bondLengthDifferenceError" value="0.01">
      </div>
      <div class="rule-config">
        <label for="defaultBondLength">Default Bond Length </label>
        <input type="text" id="defaultBondLength" value="1">
      </div>

      <button id="inspecto">Apply Rules</button>
      <section class="validation-results"></section>
    </section>
  </div>

  <script type="module">
    // TODO: refactor it
    import { Inspecto } from "../build/inspecto.js";
    import { trippleBondAngleRule, bondLengthRule, overlappingBonds } from "../build/rules.js";

    // setup default values
    document.querySelector('#angleDiffError').value = trippleBondAngleRule.config.angleDiffError;
    document.querySelector('#fixingRule').checked = trippleBondAngleRule.config.fixingRule;

    document.querySelector('#bondLengthDifferenceError').value = bondLengthRule.config.differenceError;
    document.querySelector('#defaultBondLength').value = bondLengthRule.config.bondLength;


    const button = document.getElementById('inspecto');

    button.addEventListener('click', async () => {
      const results = document.querySelector('.validation-results');
      const ketcher = document.getElementById('ketcher').contentWindow.ketcher;
      const ketFile = await ketcher.getKet();

      results.innerHTML = '';
      button.disabled = true;

      trippleBondAngleRule.updateConfig({
        angleDiffError: document.querySelector('#angleDiffError').value,
        fixingRule: document.querySelector('#fixingRule').checked
      });

      bondLengthRule.updateConfig({
        bondLength: document.querySelector('#defaultBondLength').value, 
        differenceError: document.querySelector('#bondLengthDifferenceError').value
      });

      const result = await Inspecto.applyRulesToStructure(
        [trippleBondAngleRule, bondLengthRule, overlappingBonds],
        ketFile
      );

      for (const ruleName of Object.keys(result.validation)) {
        const ruleValidationNode = document.createElement('div');
        const ruleNameNode = document.createElement('h2');
        ruleNameNode.textContent = ruleName;
        ruleValidationNode.appendChild(ruleNameNode);

        const { data, hasErrors } = result.validation[ruleName];

        if (hasErrors) {
          const dataNode = document.createElement('div');

          for (const { message, path } of data) {
            dataNode.innerHTML += `<b>Path:</b> ${path}<br/>`;
            dataNode.innerHTML += `<b>Message:</b> ${message}<br/>`;
            dataNode.innerHTML += `<br/>`;
          }
          ruleValidationNode.appendChild(dataNode);
        } else {
          const success = document.createElement('div');
          success.classList.add('success');
          success.textContent = 'Inspecto rules are satisfied'
          ruleValidationNode.appendChild(success);
        }

        results.appendChild(ruleValidationNode);
      }

      if (document.querySelector('#fixingRule').checked) {
        const molecule = Inspecto.structureToKet(result.structure);
        console.log(molecule);
        ketcher.setMolecule(molecule);
      }

      button.disabled = false;
    });
  </script>
</body>

</html>